openapi: 3.0.3
info:
  title: RustChain Node API - Comprehensive Reference
  description: |
    Official API specification for RustChain blockchain nodes (v2.2.1-rip200).
    
    RustChain is a blockchain that supports multiple hardware architectures with
    antiquity-weighted mining rewards. This comprehensive API reference provides 
    detailed documentation for all available endpoints, including public endpoints,
    authenticated admin endpoints, and miner attestation interfaces.
    
    ## Base URLs
    - **Production Mainnet**: `https://50.28.86.131`
    - **Internal VPS**: `http://localhost:8099`
    
    ## Authentication
    - **Public Endpoints**: No authentication required
    - **Admin Endpoints**: Require `X-Admin-Key` header with admin key
    - **Transfer Endpoints**: Require Ed25519 cryptographic signatures
    
    ## HTTPS Certificate
    The production node uses a self-signed TLS certificate. When using curl, add the `-k` flag:
    ```bash
    curl -sk https://50.28.86.131/health
    ```
    
    For production applications, pin the certificate fingerprint instead of disabling verification.
    
    ## Response Status Codes
    | Code | Meaning |
    |------|---------|
    | 200 | Success |
    | 400 | Bad request (check JSON syntax) |
    | 401 | Unauthorized (missing/invalid admin key) |
    | 404 | Endpoint doesn't exist |
    | 500 | Server error |
    
    ## Rate Limits
    - Public endpoints: 100 requests/minute per IP
    - Attestation submissions: 1 per 10 minutes per miner
    - Wallet transfers: 10 per minute per wallet
    - Admin endpoints: 50 requests/minute (admin key required)
  version: 2.2.1-rip200
  contact:
    name: RustChain Development Team
    url: https://github.com/Scottcjn/Rustchain
    email: scott@rustchain.dev
  license:
    name: MIT License
    url: https://opensource.org/licenses/MIT

servers:
  - url: https://50.28.86.131
    description: RustChain Mainnet Node (Production)
  - url: http://localhost:8099
    description: Local Development Node

tags:
  - name: Health & Status
    description: Node health checks and readiness probes
  - name: Chain Information
    description: Blockchain statistics, epoch data, and network information
  - name: Miners & Attestation
    description: Miner registry, hardware information, and attestation endpoints
  - name: Wallet Operations
    description: Balance queries, transfers, and wallet management
  - name: Admin Endpoints
    description: Administrative operations requiring X-Admin-Key header
  - name: Block Explorer
    description: Web UI and block/transaction browsing endpoints

paths:
  /health:
    get:
      tags:
        - Health & Status
      summary: Node health check
      description: |
        Returns comprehensive health status including database connectivity, 
        chain synchronization, uptime, and software version.
        
        This endpoint is used by monitoring systems and load balancers to 
        determine if the node is operational.
      operationId: getHealth
      responses:
        '200':
          description: Health status response
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/HealthResponse'
              example:
                ok: true
                version: "2.2.1-rip200"
                uptime_s: 4313
                db_rw: true
                backup_age_hours: 17.15
                tip_age_slots: 0

  /ready:
    get:
      tags:
        - Health & Status
      summary: Readiness probe
      description: |
        Simple readiness check that returns 200 when the node is ready to accept traffic.
        
        Unlike `/health`, this endpoint only checks if the HTTP server is running 
        and doesn't perform deeper system checks. Used by Kubernetes and container 
        orchestration systems.
      operationId: getReady
      responses:
        '200':
          description: Node is ready
          content:
            application/json:
              schema:
                type: object
                properties:
                  ready:
                    type: boolean
                    example: true
              example:
                ready: true

  /epoch:
    get:
      tags:
        - Chain Information
      summary: Current epoch information
      description: |
        Returns detailed information about the current epoch including slot timing,
        reward pool, and enrolled miner count.
        
        Epochs last approximately 24 hours (144 slots at 10-minute intervals).
      operationId: getEpoch
      responses:
        '200':
          description: Epoch information
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/EpochResponse'
              example:
                epoch: 75
                slot: 10800
                blocks_per_epoch: 144
                epoch_pot: 1.5
                enrolled_miners: 10

  /api/miners:
    get:
      tags:
        - Miners & Attestation
      summary: List all active miners
      description: |
        Returns a complete list of all registered miners with their hardware 
        specifications, antiquity multipliers, and attestation timestamps.
        
        This endpoint does not support pagination - it returns all miners in a single response.
        For large networks, consider caching this response client-side.
      operationId: getMiners
      responses:
        '200':
          description: List of miners
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/Miner'
              example:
                - miner: "eafc6f14eab6d5c5362fe651e5e6c23581892a37RTC"
                  device_arch: "G4"
                  device_family: "PowerPC"
                  hardware_type: "PowerPC G4 (Vintage)"
                  antiquity_multiplier: 2.5
                  entropy_score: 0.0
                  last_attest: 1771187406
                  first_attest: null

  /api/nodes:
    get:
      tags:
        - Chain Information
      summary: Connected attestation nodes
      description: |
        Returns information about connected attestation nodes in the network.
        
        This includes primary, secondary, and community-operated nodes with their
        connection status and roles.
      operationId: getNodes
      responses:
        '200':
          description: List of connected nodes
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/NodeInfo'
              example:
                - address: "50.28.86.131"
                  role: "primary"
                  status: "active"
                - address: "50.28.86.153" 
                  role: "secondary"
                  status: "active"
                - address: "76.8.228.245"
                  role: "community"
                  status: "active"

  /wallet/balance:
    get:
      tags:
        - Wallet Operations
      summary: Get wallet balance
      description: |
        Returns the current RTC balance for a specific miner wallet.
        
        The balance is returned in both human-readable decimal format (`amount_rtc`)
        and raw integer format (`amount_i64`) where 1 RTC = 100,000,000 units.
      operationId: getBalance
      parameters:
        - name: miner_id
          in: query
          required: true
          description: The unique miner/wallet identifier
          schema:
            type: string
            minLength: 1
            maxLength: 256
          example: "scott"
      responses:
        '200':
          description: Balance response
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/BalanceResponse'
              example:
                ok: true
                miner_id: "scott"
                amount_rtc: 42.5
                amount_i64: 4250000000
        '400':
          description: Missing or invalid miner_id parameter
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
              example:
                ok: false
                error: "miner_id parameter is required"

  /wallet/transfer:
    post:
      tags:
        - Admin Endpoints
      summary: Internal RTC transfer (admin only)
      description: |
        **ADMIN ONLY**: Transfer RTC between miner wallets without requiring signatures.
        
        This endpoint requires the `X-Admin-Key` header with a valid admin key.
        It bypasses normal signature requirements and should only be used for 
        administrative purposes like bounty payouts or system maintenance.
      operationId: adminTransfer
      security:
        - AdminKey: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/AdminTransferRequest'
            example:
              from_miner: "scott"
              to_miner: "pffs1802"
              amount_rtc: 5.0
      responses:
        '200':
          description: Transfer successful
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/TransferResponse'
              example:
                success: true
                tx_hash: "9e75c9b8e67c87d9fb898aa8891f83a6"
                from_miner: "scott"
                to_miner: "pffs1802"
                amount_rtc: 5.0
        '401':
          description: Invalid or missing admin key
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
              example:
                error: "Invalid or missing X-Admin-Key header"

  /rewards/settle:
    post:
      tags:
        - Admin Endpoints
      summary: Trigger epoch settlement
      description: |
        **ADMIN ONLY**: Manually trigger the epoch reward settlement process.
        
        Normally, settlements occur automatically at the end of each epoch.
        This endpoint allows administrators to force settlement for testing
        or emergency situations.
      operationId: triggerSettlement
      security:
        - AdminKey: []
      responses:
        '200':
          description: Settlement triggered successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                    example: true
                  message:
                    type: string
                    example: "Epoch settlement process initiated"
              example:
                success: true
                message: "Epoch settlement process initiated"
        '401':
          description: Invalid or missing admin key
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
              example:
                error: "Invalid or missing X-Admin-Key header"

  /attest/submit:
    post:
      tags:
        - Miners & Attestation
      summary: Submit hardware attestation
      description: |
        Submit a hardware fingerprint attestation for epoch enrollment and reward eligibility.
        
        The attestation includes multiple hardware characteristics that prove the miner
        is running on genuine vintage or modern hardware (not virtualized).
        
        Successful attestations enroll the miner in the current epoch's reward pool.
      operationId: submitAttestation
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/AttestationRequest'
            example:
              miner_id: "my-vintage-g4-miner"
              fingerprint:
                clock_skew:
                  mean_ppm: -125
                  variance_ppm: 8.2
                cache_timing:
                  l1_ns: 1.2
                  l2_ns: 8.7
                  l3_ns: 42.1
                simd_identity:
                  neon_present: false
                  avx_present: false
                  sse_present: true
                thermal_entropy:
                  idle_temp_c: 38
                  load_temp_c: 62
                  thermal_throttle_observed: false
                instruction_jitter:
                  mean_cycles: 2.1
                  variance_cycles: 0.3
                behavioral_heuristics:
                  hypervisor_signature: false
                  vm_exit_overhead: false
                  tsc_invariant: true
              signature: "base64_ed25519_signature_over_fingerprint"
      responses:
        '200':
          description: Attestation submitted successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/AttestationResponse'
              example:
                success: true
                enrolled: true
                epoch: 75
                multiplier: 2.5
                next_settlement_slot: 10944
        '400':
          description: Invalid attestation data
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
              examples:
                vm_detected:
                  summary: Virtual machine detected
                  value:
                    success: false
                    error: "VM_DETECTED"
                    check_failed: "behavioral_heuristics"
                    detail: "Hypervisor signature detected in CPUID"
                invalid_signature:
                  summary: Invalid signature
                  value:
                    success: false
                    error: "INVALID_SIGNATURE"
                    detail: "Ed25519 signature verification failed"

  /lottery/eligibility:
    get:
      tags:
        - Miners & Attestation
      summary: Check reward eligibility
      description: |
        Check if a miner is eligible for epoch rewards based on their attestation status.
        
        Returns the miner's current eligibility status, multiplier, and next attestation window.
      operationId: checkEligibility
      parameters:
        - name: miner_id
          in: query
          required: true
          description: The miner identifier to check
          schema:
            type: string
          example: "my-vintage-g4-miner"
      responses:
        '200':
          description: Eligibility status
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/EligibilityResponse'
              example:
                eligible: true
                multiplier: 2.5
                last_attest: 1771187406
                next_attest_window: 1771247406
                current_epoch: 75

  /explorer:
    get:
      tags:
        - Block Explorer
      summary: Web UI block explorer
      description: |
        Serves the web-based block explorer interface for browsing blocks, transactions,
        and miner activity.
        
        This endpoint returns HTML content for the interactive explorer UI.
        For programmatic access to blockchain data, use the JSON APIs instead.
      operationId: getExplorer
      responses:
        '200':
          description: Block explorer web interface
          content:
            text/html:
              schema:
                type: string
                format: html
              example: "<!DOCTYPE html><html>...</html>"

components:
  securitySchemes:
    AdminKey:
      type: apiKey
      in: header
      name: X-Admin-Key
      description: |
        Admin key required for administrative endpoints.
        The key is: `rustchain_admin_key_2025_secure64`

  schemas:
    HealthResponse:
      type: object
      required:
        - ok
        - version
        - uptime_s
        - db_rw
        - tip_age_slots
      properties:
        ok:
          type: boolean
          description: Overall health status (true = healthy)
          example: true
        version:
          type: string
          description: Node software version with protocol identifier
          example: "2.2.1-rip200"
        uptime_s:
          type: integer
          format: int64
          description: Node uptime in seconds since last restart
          minimum: 0
          example: 4313
        db_rw:
          type: boolean
          description: Database read/write accessibility status
          example: true
        tip_age_slots:
          type: integer
          description: Number of slots behind the current chain tip (0 = fully synced)
          minimum: 0
          example: 0
        backup_age_hours:
          type: number
          format: double
          description: Hours since last database backup
          minimum: 0
          example: 17.15

    EpochResponse:
      type: object
      required:
        - epoch
        - slot
        - blocks_per_epoch
        - epoch_pot
        - enrolled_miners
      properties:
        epoch:
          type: integer
          description: Current epoch number
          minimum: 0
          example: 75
        slot:
          type: integer
          description: Current slot within the epoch
          minimum: 0
          example: 10800
        blocks_per_epoch:
          type: integer
          description: Total slots per epoch (defines epoch duration)
          minimum: 1
          example: 144
        epoch_pot:
          type: number
          format: double
          description: Total RTC available for distribution in current epoch
          minimum: 0
          example: 1.5
        enrolled_miners:
          type: integer
          description: Number of miners enrolled and eligible for rewards
          minimum: 0
          example: 10

    Miner:
      type: object
      required:
        - miner
        - device_arch
        - device_family
        - hardware_type
        - antiquity_multiplier
        - last_attest
      properties:
        miner:
          type: string
          description: Unique miner identifier (wallet address)
          minLength: 1
          maxLength: 256
          example: "eafc6f14eab6d5c5362fe651e5e6c23581892a37RTC"
        device_arch:
          type: string
          description: Specific CPU architecture identifier
          example: "G4"
        device_family:
          type: string
          description: CPU family category
          enum:
            - PowerPC
            - x86_64
            - x86
            - Apple Silicon
            - ARM64
          example: "PowerPC"
        hardware_type:
          type: string
          description: Human-readable hardware description
          example: "PowerPC G4 (Vintage)"
        antiquity_multiplier:
          type: number
          format: double
          description: Reward multiplier based on hardware age and rarity
          minimum: 0
          maximum: 2.5
          example: 2.5
        entropy_score:
          type: number
          format: double
          description: Hardware entropy contribution quality score
          minimum: 0
          maximum: 1
          example: 0.0
        last_attest:
          type: integer
          format: int64
          description: Unix timestamp of most recent successful attestation
          minimum: 0
          example: 1771187406
        first_attest:
          type: integer
          format: int64
          description: Unix timestamp of first attestation (null if never attested)
          nullable: true
          example: null

    NodeInfo:
      type: object
      required:
        - address
        - role
        - status
      properties:
        address:
          type: string
          description: IP address or hostname of the node
          format: ipv4
          example: "50.28.86.131"
        role:
          type: string
          description: Node role in the network
          enum:
            - primary
            - secondary
            - community
          example: "primary"
        status:
          type: string
          description: Current operational status
          enum:
            - active
            - inactive
            - maintenance
          example: "active"

    BalanceResponse:
      type: object
      required:
        - ok
        - miner_id
        - amount_rtc
        - amount_i64
      properties:
        ok:
          type: boolean
          description: Request success status
          example: true
        miner_id:
          type: string
          description: Requested miner identifier
          minLength: 1
          maxLength: 256
          example: "scott"
        amount_rtc:
          type: number
          format: double
          description: Balance in RTC (human readable decimal format)
          minimum: 0
          example: 42.5
        amount_i64:
          type: integer
          format: int64
          description: Balance in micro-RTC units (1 RTC = 100,000,000 units)
          minimum: 0
          example: 4250000000

    AdminTransferRequest:
      type: object
      required:
        - from_miner
        - to_miner
        - amount_rtc
      properties:
        from_miner:
          type: string
          description: Source miner wallet identifier
          minLength: 1
          maxLength: 256
          example: "scott"
        to_miner:
          type: string
          description: Destination miner wallet identifier
          minLength: 1
          maxLength: 256
          example: "pffs1802"
        amount_rtc:
          type: number
          format: double
          description: Amount to transfer in RTC
          minimum: 0
          exclusiveMinimum: true
          example: 5.0

    TransferResponse:
      type: object
      required:
        - success
      properties:
        success:
          type: boolean
          description: Transfer success status
          example: true
        tx_hash:
          type: string
          description: Transaction hash for the transfer
          example: "9e75c9b8e67c87d9fb898aa8891f83a6"
        from_miner:
          type: string
          description: Source miner identifier
          example: "scott"
        to_miner:
          type: string
          description: Destination miner identifier
          example: "pffs1802"
        amount_rtc:
          type: number
          format: double
          description: Transferred amount in RTC
          example: 5.0

    AttestationRequest:
      type: object
      required:
        - miner_id
        - fingerprint
        - signature
      properties:
        miner_id:
          type: string
          description: Miner identifier submitting the attestation
          minLength: 1
          maxLength: 256
          example: "my-vintage-g4-miner"
        fingerprint:
          type: object
          description: Hardware fingerprint data
          required:
            - clock_skew
            - cache_timing
            - simd_identity
            - thermal_entropy
            - instruction_jitter
            - behavioral_heuristics
          properties:
            clock_skew:
              type: object
              description: CPU clock skew measurements
              properties:
                mean_ppm:
                  type: integer
                  description: Mean parts-per-million clock deviation
                  example: -125
                variance_ppm:
                  type: number
                  format: double
                  description: Variance in clock measurements
                  example: 8.2
            cache_timing:
              type: object
              description: Memory cache timing characteristics
              properties:
                l1_ns:
                  type: number
                  format: double
                  description: L1 cache access time in nanoseconds
                  example: 1.2
                l2_ns:
                  type: number
                  format: double
                  description: L2 cache access time in nanoseconds
                  example: 8.7
                l3_ns:
                  type: number
                  format: double
                  description: L3 cache access time in nanoseconds
                  example: 42.1
            simd_identity:
              type: object
              description: SIMD instruction set capabilities
              properties:
                neon_present:
                  type: boolean
                  description: ARM NEON instructions available
                  example: false
                avx_present:
                  type: boolean
                  description: Intel AVX instructions available
                  example: false
                sse_present:
                  type: boolean
                  description: Intel SSE instructions available
                  example: true
            thermal_entropy:
              type: object
              description: Thermal characteristics for entropy generation
              properties:
                idle_temp_c:
                  type: integer
                  description: CPU temperature at idle in Celsius
                  example: 38
                load_temp_c:
                  type: integer
                  description: CPU temperature under load in Celsius
                  example: 62
                thermal_throttle_observed:
                  type: boolean
                  description: Whether thermal throttling was observed
                  example: false
            instruction_jitter:
              type: object
              description: Instruction execution timing variability
              properties:
                mean_cycles:
                  type: number
                  format: double
                  description: Mean instruction execution cycles
                  example: 2.1
                variance_cycles:
                  type: number
                  format: double
                  description: Variance in instruction timing
                  example: 0.3
            behavioral_heuristics:
              type: object
              description: Behavioral indicators of virtualization
              properties:
                hypervisor_signature:
                  type: boolean
                  description: Hypervisor signatures detected in CPUID
                  example: false
                vm_exit_overhead:
                  type: boolean
                  description: VM exit overhead detected
                  example: false
                tsc_invariant:
                  type: boolean
                  description: Time Stamp Counter is invariant
                  example: true
        signature:
          type: string
          description: Base64-encoded Ed25519 signature over the fingerprint data
          format: byte
          example: "base64_ed25519_signature_over_fingerprint"

    AttestationResponse:
      type: object
      required:
        - success
      properties:
        success:
          type: boolean
          description: Attestation submission success
          example: true
        enrolled:
          type: boolean
          description: Whether the miner was enrolled in rewards
          example: true
        epoch:
          type: integer
          description: Epoch number for enrollment
          example: 75
        multiplier:
          type: number
          format: double
          description: Assigned antiquity multiplier
          example: 2.5
        next_settlement_slot:
          type: integer
          description: Slot number when next settlement occurs
          example: 10944
        error:
          type: string
          description: Error code if attestation failed
          example: "VM_DETECTED"
        check_failed:
          type: string
          description: Specific check that failed
          example: "behavioral_heuristics"
        detail:
          type: string
          description: Detailed error description
          example: "Hypervisor signature detected in CPUID"

    EligibilityResponse:
      type: object
      required:
        - eligible
        - multiplier
        - current_epoch
      properties:
        eligible:
          type: boolean
          description: Whether miner is currently eligible for rewards
          example: true
        multiplier:
          type: number
          format: double
          description: Current reward multiplier
          example: 2.5
        last_attest:
          type: integer
          format: int64
          description: Timestamp of last successful attestation
          example: 1771187406
        next_attest_window:
          type: integer
          format: int64
          description: Timestamp when next attestation window opens
          example: 1771247406
        current_epoch:
          type: integer
          description: Current epoch number
          example: 75

    ErrorResponse:
      type: object
      required:
        - error
      properties:
        ok:
          type: boolean
          description: Always false for errors
          example: false
        success:
          type: boolean
          description: Always false for errors
          example: false
        error:
          type: string
          description: Error message or code
          example: "VM_DETECTED"
        detail:
          type: string
          description: Additional error details
          example: "Hypervisor signature detected in CPUID"
        check_failed:
          type: string
          description: Specific validation that failed
          example: "behavioral_heuristics"