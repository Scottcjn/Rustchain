name: CI Pipeline

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]

jobs:
  lint:
    name: Lint (ruff)
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install ruff
        run: pip install ruff

      - name: Run ruff lint
        run: |
          ruff check node/ \
            --exclude node/__pycache__,node/*.pyc \
            --select E,F,W,I \
            --ignore E501,E402,E741 \
            --output-format=github

      - name: Run ruff format check
        run: ruff format --check node/
        continue-on-error: true

  typecheck:
    name: Type Check (mypy)
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install mypy
        run: pip install mypy

      - name: Run mypy (new code only)
        run: |
          # Create a minimal stub for checking only new/changed files
          mypy node/rustchain_v2_integrated_v2.2.1_rip200.py \
            --ignore-missing-imports \
            --warn-return-any \
            --warn-unused-configs \
            --no-error-summary \
            2>&1 | head -100 || true
        continue-on-error: true

  security-scan:
    name: Security Scan (bandit)
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install bandit
        run: pip install bandit[toml]

      - name: Run bandit security scan
        run: |
          bandit -r node/ \
            -f json \
            -o bandit-report.json \
            --skip B101,B601,B602 \
            || true

      - name: Upload bandit report
        uses: actions/upload-artifact@v4
        with:
          name: bandit-report
          path: bandit-report.json

      - name: Check for high-severity issues
        run: |
          bandit -r node/ --skip B101,B601,B602 -ll || true
        continue-on-error: true

  test:
    name: Tests (pytest)
    runs-on: ubuntu-latest
    strategy:
      matrix:
        python-version: ['3.10', '3.11', '3.12']
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python ${{ matrix.python-version }}
        uses: actions/setup-python@v5
        with:
          python-version: ${{ matrix.python-version }}

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install pytest pytest-cov pytest-mock

      - name: Run tests with coverage
        run: |
          pytest tests/ \
            -v \
            --cov=node \
            --cov-report=xml \
            --cov-report=term-missing \
            --tb=short

      - name: Upload coverage to Codecov
        uses: codecov/codecov-action@v4
        with:
          file: ./coverage.xml
          flags: unittests
          name: codecov-${{ matrix.python-version }}
        if: matrix.python-version == '3.11'

  final-check:
    name: Final Status Check
    runs-on: ubuntu-latest
    needs: [lint, typecheck, security-scan, test]
    if: always()
    steps:
      - name: Check job results
        run: |
          if [ "${{ needs.lint.result }}" != "success" ] && [ "${{ needs.lint.result }}" != "skipped" ]; then
            echo "::error::Lint job failed"
            exit 1
          fi
          if [ "${{ needs.test.result }}" != "success" ]; then
            echo "::error::Tests failed"
            exit 1
          fi
          echo "All checks passed!"
