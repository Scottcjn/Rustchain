name: RustChain Badge Updater

on:
  schedule:
    # Run every 15 minutes to keep badges fresh
    - cron: '*/15 * * * *'
  workflow_dispatch:
    inputs:
      miner_id:
        description: 'Miner ID to update badge for'
        required: true
        default: 'default'
      node_url:
        description: 'RustChain node URL'
        required: true
        default: 'https://rustchain.org'

jobs:
  update-badge:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          
      - name: Update miner badge
        id: update_badge
        run: |
          import json
          import urllib.request
          import urllib.error
          import os
          import sys
          
          # Get inputs
          miner_id = os.environ.get('MINER_ID', 'default')
          node_url = os.environ.get('NODE_URL', 'https://rustchain.org').rstrip('/')
          
          print(f"Fetching badge for miner: {miner_id}")
          print(f"Node URL: {node_url}")
          
          # Fetch badge data from RustChain node
          badge_url = f"{node_url}/api/badge/{miner_id}"
          
          try:
              req = urllib.request.Request(
                  badge_url,
                  headers={'Accept': 'application/json', 'User-Agent': 'RustChain-Badge-Updater/1.0'}
              )
              
              with urllib.request.urlopen(req, timeout=30) as response:
                  badge_data = json.loads(response.read().decode('utf-8'))
                  
              # Ensure badge directory exists
              os.makedirs('badges/dynamic', exist_ok=True)
              
              # Save badge data
              badge_file = f'badges/dynamic/{miner_id}.json'
              with open(badge_file, 'w') as f:
                  json.dump(badge_data, f, indent=2)
              
              print(f"✅ Badge saved to {badge_file}")
              print(f"Status: {badge_data.get('message', 'unknown')}")
              print(f"Color: {badge_data.get('color', 'unknown')}")
              
              # Also create a markdown badge reference
              shield_url = f"https://img.shields.io/endpoint?url={node_url}/api/badge/{miner_id}"
              readme_badge = f"![RustChain Status]({shield_url})"
              
              with open(f'badges/dynamic/{miner_id}.md', 'w') as f:
                  f.write(f"# RustChain Badge for {miner_id}\n\n")
                  f.write(f"{readme_badge}\n\n")
                  f.write(f"**Status:** {badge_data.get('message', 'unknown')}\n\n")
                  f.write(f"**Last Updated:** {badge_data.get('timestamp', 'N/A')}\n\n")
                  f.write(f"**Raw JSON:** [{badge_file}](./{miner_id}.json)\n")
              
              # Set output for next steps
              with open(os.environ.get('GITHUB_OUTPUT', '/dev/null'), 'a') as f:
                  f.write(f"status={badge_data.get('message', 'unknown')}\n")
                  f.write(f"color={badge_data.get('color', 'unknown')}\n")
                  f.write(f"changed=true\n")
              
          except urllib.error.HTTPError as e:
              print(f"❌ HTTP Error {e.code}: {e.reason}")
              # Create fallback badge
              fallback = {
                  "schemaVersion": 1,
                  "label": f"⛏ {miner_id}",
                  "message": "offline",
                  "color": "lightgrey"
              }
              os.makedirs('badges/dynamic', exist_ok=True)
              with open(f'badges/dynamic/{miner_id}.json', 'w') as f:
                  json.dump(fallback, f, indent=2)
              sys.exit(0)  # Don't fail the workflow
              
          except Exception as e:
              print(f"❌ Error: {e}")
              sys.exit(1)
        shell: python
        env:
          MINER_ID: ${{ github.event.inputs.miner_id || 'default' }}
          NODE_URL: ${{ github.event.inputs.node_url || 'https://rustchain.org' }}
          
      - name: Commit and push changes
        if: steps.update_badge.outputs.changed == 'true'
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          
          git add badges/dynamic/
          
          if git diff --staged --quiet; then
            echo "No changes to commit"
            exit 0
          fi
          
          git commit -m "Update RustChain badge for ${{ github.event.inputs.miner_id || 'default' }}

Status: ${{ steps.update_badge.outputs.status }}
Color: ${{ steps.update_badge.outputs.color }}

Auto-generated by RustChain Badge Updater"
          
          git push
