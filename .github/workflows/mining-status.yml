name: Mining Status Badge

on:
  schedule:
    - cron: '*/15 * * * *'
  workflow_dispatch:

jobs:
  update-badge:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      
      - name: Fetch Status
        id: fetch_status
        run: |
          RAW_DATA=$(curl -s --fail --max-time 10 https://rustchain.org/beacon/relay/discover || echo "[]")
          STATUS=$(echo "$RAW_DATA" | jq -r '.[0].status // "Inactive"' 2>/dev/null || echo "Inactive")
          echo "MINING_STATUS=$STATUS" >> $GITHUB_ENV
          
      - name: Generate Badge
        run: |
          COLOR="#4c1"
          if [ "$MINING_STATUS" != "active" ]; then
            COLOR="#9f9f9f"
          fi
          mkdir -p badges
          # Using a safe multiline string approach to avoid YAML heredoc issues
          echo '<svg xmlns="http://www.w3.org/2000/svg" width="100" height="20">' > badges/mining-status.svg
          echo '  <linearGradient id="b" x2="0" y2="100%"><stop offset="0" stop-color="#bbb" stop-opacity=".1"/><stop offset="1" stop-opacity=".1"/></linearGradient>' >> badges/mining-status.svg
          echo '  <mask id="a"><rect width="100" height="20" rx="3" fill="#fff"/></mask>' >> badges/mining-status.svg
          echo '  <g mask="url(#a)">' >> badges/mining-status.svg
          echo '    <path fill="#555" d="M0 0h60v20H0z"/>' >> badges/mining-status.svg
          echo '    <path fill="'$COLOR'" d="M60 0h40v20H60z"/>' >> badges/mining-status.svg
          echo '    <path fill="url(#b)" d="M0 0h100v20H0z"/>' >> badges/mining-status.svg
          echo '  </g>' >> badges/mining-status.svg
          echo '  <g fill="#fff" text-anchor="middle" font-family="DejaVu Sans,Verdana,Geneva,sans-serif" font-size="11">' >> badges/mining-status.svg
          echo '    <text x="30" y="15" fill="#010101" fill-opacity=".3">Mining</text>' >> badges/mining-status.svg
          echo '    <text x="30" y="14">Mining</text>' >> badges/mining-status.svg
          echo '    <text x="80" y="15" fill="#010101" fill-opacity=".3">'$MINING_STATUS'</text>' >> badges/mining-status.svg
          echo '    <text x="80" y="14">'$MINING_STATUS'</text>' >> badges/mining-status.svg
          echo '  </g>' >> badges/mining-status.svg
          echo '</svg>' >> badges/mining-status.svg

      - name: Commit and Push
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          git add badges/mining-status.svg
          git commit -m "docs: update mining status badge [skip ci]" || echo "No changes to commit"
          git push
