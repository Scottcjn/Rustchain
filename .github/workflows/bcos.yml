name: BCOS Checks

on:
  pull_request:
    types: [opened, synchronize, reopened, labeled, unlabeled]

permissions:
  contents: read
  pull-requests: read

jobs:
  label-gate:
    name: Review Tier Label Gate
    runs-on: ubuntu-latest
    steps:
      - name: Require BCOS label for non-doc PRs
        uses: actions/github-script@v7
        with:
          script: |
            const owner = context.repo.owner;
            const repo = context.repo.repo;
            const pr = context.payload.pull_request;
            const prNumber = pr.number;

            const allowedLabels = new Set(["BCOS-L1", "BCOS-L2", "bcos:l1", "bcos:l2"]);

            const labels = (pr.labels || []).map(l => l.name);
            const hasTier = labels.some(l => allowedLabels.has(l));

            // Fetch file list (paginated)
            const files = [];
            for await (const resp of github.paginate.iterator(
              github.rest.pulls.listFiles,
              { owner, repo, pull_number: prNumber, per_page: 100 }
            )) {
              for (const f of resp.data) files.push(f.filename);
            }

            function isDocOnly(path) {
              const p = path.toLowerCase();
              if (p.startsWith("docs/")) return true;
              if (p.endsWith(".md")) return true;
              if (p.endsWith(".png") || p.endsWith(".jpg") || p.endsWith(".jpeg") || p.endsWith(".gif") || p.endsWith(".svg")) return true;
              if (p.endsWith(".pdf")) return true;
              return false;
            }

            const nonDoc = files.filter(f => !isDocOnly(f));
            if (nonDoc.length === 0) {
              core.info("Doc-only PR: tier label not required.");
              return;
            }

            if (!hasTier) {
              core.setFailed(
                "BCOS label required for non-doc changes. Add one of: BCOS-L1, BCOS-L2 (or bcos:l1, bcos:l2)."
              );
            } else {
              core.info(`Tier label present: ${labels.join(", ")}`);
            }

  spdx-and-sbom:
    name: SPDX + SBOM Artifacts
    runs-on: ubuntu-latest
    needs: [label-gate]
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install tooling (venv)
        run: |
          python -m venv .venv-bcos
          . .venv-bcos/bin/activate
          python -m pip install --upgrade pip
          # SBOM + license report (for evidence; does not change runtime)
          python -m pip install cyclonedx-bom pip-licenses

      - name: SPDX check (new files)
        run: |
          . .venv-bcos/bin/activate
          python tools/bcos_spdx_check.py --base-ref "origin/${{ github.base_ref }}"

      - name: Generate SBOM (environment)
        run: |
          . .venv-bcos/bin/activate
          mkdir -p artifacts
          python -m cyclonedx_py environment --format json -o artifacts/sbom_environment.json

      - name: Generate dependency license report
        run: |
          . .venv-bcos/bin/activate
          mkdir -p artifacts
          pip-licenses --format=json --with-system --with-license-file --output-file artifacts/pip_licenses.json

      - name: Upload BCOS artifacts
        uses: actions/upload-artifact@v4
        with:
          name: bcos-artifacts
          path: artifacts/

