name: PR Mining Status Comment

on:
  pull_request:
    types: [opened, synchronize, reopened]

jobs:
  post-mining-status:
    runs-on: ubuntu-latest
    permissions:
      pull-requests: write
      contents: read

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Fetch and Post Mining Status
        uses: actions/github-script@v7
        with:
          script: |
            const https = require('https');
            
            // Get miner ID from PR author or use default
            const minerId = context.payload.pull_request.user.login || 'default';
            const nodeUrl = 'https://rustchain.org';
            
            console.log(`Fetching mining status for: ${minerId}`);
            
            // Fetch badge data from RustChain API
            const badgeUrl = `${nodeUrl}/api/badge/${minerId}`;
            
            try {
              const response = await fetch(badgeUrl, {
                headers: {
                  'Accept': 'application/json',
                  'User-Agent': 'RustChain-PR-Bot/1.0'
                }
              });
              
              let badgeData;
              let statusMessage = 'unknown';
              let statusColor = 'lightgrey';
              let hashrate = 'N/A';
              let uptime = 'N/A';
              
              if (response.ok) {
                badgeData = await response.json();
                statusMessage = badgeData.message || 'active';
                statusColor = badgeData.color || 'green';
                
                // Parse hashrate and uptime from message if available
                const messageParts = statusMessage.split('|').map(s => s.trim());
                if (messageParts.length >= 2) {
                  hashrate = messageParts[0];
                  uptime = messageParts[1];
                }
              } else {
                console.log(`API returned ${response.status}: ${response.statusText}`);
                statusMessage = 'offline';
              }
              
              // Create status badge
              const badgeUrl = `https://img.shields.io/badge/mining-${encodeURIComponent(statusMessage)}-${statusColor}`;
              
              // Build comment body
              const commentBody = `## ‚õèÔ∏è RustChain Mining Status
              
              | Metric | Value |
              |--------|-------|
              | **Miner ID** | \`${minerId}\` |
              | **Status** | ![Status](${badgeUrl}) |
              | **Hashrate** | ${hashrate} |
              | **Uptime** | ${uptime} |
              | **Node** | ${nodeUrl} |
              
              <details>
              <summary>üìä Raw Badge Data</summary>
              
              \`\`\`json
              ${JSON.stringify(badgeData || { error: 'No data available' }, null, 2)}
              \`\`\`
              </details>
              
              ---
              *Auto-generated by RustChain Mining Status Bot*`;
              
              // Post comment on PR
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body: commentBody
              });
              
              console.log('‚úÖ Mining status comment posted successfully');
              
            } catch (error) {
              console.error('‚ùå Error fetching or posting mining status:', error.message);
              
              // Post error comment
              const errorBody = `## ‚õèÔ∏è RustChain Mining Status
              
              ‚ö†Ô∏è Unable to fetch mining status for \`${minerId}\`.
              
              **Error:** ${error.message}
              
              Please check that:
              - The miner ID \`${minerId}\` is registered on RustChain
              - The RustChain node at ${nodeUrl} is accessible
              
              ---
              *Auto-generated by RustChain Mining Status Bot*`;
              
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body: errorBody
              });
            }
